<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrace</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .teacher-item,
        .res-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            gap: 10px;
            background: white;
            transition: background 0.2s;
        }

        .teacher-item:hover {
            background: #f9f9f9;
        }

        .teacher-item.dragging {
            opacity: 0.5;
            background: #e1f5fe;
            border: 2px dashed #03a9f4;
        }

        .teacher-item .drag-handle {
            cursor: grab;
            color: #ccc;
            padding: 0 5px;
            font-size: 20px;
            user-select: none;
        }

        .teacher-item .drag-handle:active {
            cursor: grabbing;
        }

        .res-group {
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .res-group-header {
            background: #f5f5f5;
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .res-group-header:hover {
            background: #eee;
        }

        .res-group-content {
            padding: 0 15px;
            display: none;
        }

        .res-group.active .res-group-content {
            display: block;
        }

        .res-item span {
            flex: 1;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }
        /* ... previous styles ... */
        .btn-green { background-color: #4caf50; }
        .btn-red { background-color: #f44336; }
        .btn-orange { background-color: #ff9800; }

        .tabs {
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }

        .tab-btn.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: bold;
        }

        @media (max-width: 600px) {
            .admin-container {
                margin: 10px auto;
                padding: 15px;
                width: 95%;
            }

            .teacher-item,
            .res-item {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
                padding: 15px 0;
            }

            .teacher-item input,
            .res-item span {
                width: 100% !important;
                margin-bottom: 5px;
            }

            .res-item span {
                text-align: left;
                padding: 2px 0;
            }

            .tab-btn {
                padding: 10px 10px;
                font-size: 14px;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>

<body>
    <div id="login-screen" class="admin-container">
        <h2>P≈ôihl√°≈°en√≠</h2>
        <div class="form-group">
            <label>Heslo</label>
            <input type="password" id="admin-password">
        </div>
        <button class="btn" onclick="login()">P≈ôihl√°sit</button>
    </div>

    <div id="dashboard-screen" class="admin-container" style="display:none;">
        <div
            style="background:#f0f0f0; padding:10px; margin-bottom:15px; border-radius:4px; font-size:12px; color:#555; display:flex; justify-content:space-between; align-items:center;">
            <span>Stav √∫lo≈æi≈°tƒõ: <strong id="storage-status">Loading...</strong></span>
            <button class="btn btn-red" onclick="logout()" style="padding: 5px 10px; font-size:11px;">Odhl√°sit</button>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('teachers')">Uƒçitel√©</button>
            <button class="tab-btn" onclick="showTab('reservations')">Rezervace</button>
        </div>

        <!-- TEACHERS TAB -->
        <div id="tab-teachers">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Spr√°va uƒçitel≈Ø</h2>
                <span style="font-size:12px; color:#888;">üí° Uƒçitele m≈Ø≈æete ≈ôadit p≈ôeta≈æen√≠m</span>
            </div>
            <div id="teachers-list"></div>
            <button class="btn btn-green" onclick="addTeacher()" style="margin-top: 15px;">+ P≈ôidat uƒçitele</button>
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <button class="btn" onclick="saveSettings()">Ulo≈æit nastaven√≠</button>
            </div>
        </div>

        <!-- RESERVATIONS TAB -->
        <div id="tab-reservations" style="display:none;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0;">Spr√°va rezervac√≠</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-orange" onclick="loadReservations()">Obnovit</button>
                    <button class="btn btn-red" onclick="resetReservations()">Resetovat v≈°e</button>
                </div>
            </div>
            <div id="reservations-list"></div>
        </div>
    </div>

    <script>
        let sessionToken = null;
        let teachers = [];

        async function login() {
            const password = document.getElementById('admin-password').value;
            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const contentType = res.headers.get("content-type");
                let data;
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await res.json();
                } else {
                    throw new Error('Server returned non-JSON error');
                }

                if (data.success) {
                    sessionToken = data.token;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('dashboard-screen').style.display = 'block';
                    loadConfig();
                    loadReservations();
                } else {
                    alert('Chyba: ' + (data.error || '≈†patn√© heslo'));
                }
            } catch (e) {
                alert('Chyba komunikace se serverem: ' + e.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = Array.from(document.querySelectorAll('.tab-btn')).find(b => b.textContent.toLowerCase().includes(tab === 'teachers' ? 'uƒçitel√©' : 'rezervace'));
            if (activeBtn) activeBtn.classList.add('active');

            document.getElementById('tab-teachers').style.display = tab === 'teachers' ? 'block' : 'none';
            document.getElementById('tab-reservations').style.display = tab === 'reservations' ? 'block' : 'none';
        }

        async function loadConfig() {
            const res = await fetch('/api/config');
            const data = await res.json();
            teachers = data.teachers;
            if (data.storageMode) {
                const el = document.getElementById('storage-status');
                el.textContent = data.storageMode;
                el.style.color = data.storageMode.includes('Connected') ? 'green' : (data.storageMode.includes('ERROR') ? 'red' : '#555');
            }
            renderTeachers();
        }

        async function loadReservations() {
            const res = await fetch('/api/reservations');
            const data = await res.json(); 

            const list = document.getElementById('reservations-list');
            list.innerHTML = '';

            // Grouping logic
            const teacherNames = teachers.map(t => t.name);
            teacherNames.forEach(teacher => {
                const teacherReservations = data[teacher] || {};
                const times = Object.keys(teacherReservations).sort();
                
                if (times.length > 0) {
                    const group = document.createElement('div');
                    group.className = 'res-group';
                    group.innerHTML = `
                        <div class="res-group-header" onclick="this.parentElement.classList.toggle('active')">
                            <span>${teacher} (${times.length})</span>
                            <span>‚Üï</span>
                        </div>
                        <div class="res-group-content"></div>
                    `;
                    const content = group.querySelector('.res-group-content');
                    
                    times.forEach(time => {
                        const r = teacherReservations[time];
                        const row = document.createElement('div');
                        row.className = 'res-item';
                        row.innerHTML = `
                            <span style="width: 60px; font-weight:bold;">${time}</span>
                            <span>${r.name}</span>
                            <button class="btn btn-red" style="padding: 5px 10px; font-size:12px;" onclick="deleteReservation('${teacher}', '${time}')">Smazat</button>
                        `;
                        content.appendChild(row);
                    });
                    list.appendChild(group);
                }
            });

            if (list.children.length === 0) list.innerHTML = '<p style="text-align:center; padding:20px; color:#888;">≈Ω√°dn√© aktivn√≠ rezervace.</p>';
        }

        async function deleteReservation(teacher, time) {
            if (!confirm(`Opravdu smazat rezervaci ${teacher} v ${time}?`)) return;

            const res = await fetch('/api/admin/delete-reservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: sessionToken, teacher, time })
            });

            if (res.ok) {
                loadReservations();
            } else {
                alert('Chyba p≈ôi maz√°n√≠.');
            }
        }

        async function resetReservations() {
            if (!confirm('VAROV√ÅN√ç: Tato akce vyma≈æe V≈†ECHNY rezervace rodiƒç≈Ø! Uƒçitel√© z≈Østanou zachov√°ni. Pokraƒçovat?')) return;
            if (!confirm('OPRAVDU SMAZAT V≈†ECHNA DATA? Tuto akci nelze vr√°tit.')) return;

            const res = await fetch('/api/admin/reset-all', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: sessionToken })
            });

            if (res.ok) {
                alert('V≈°echny rezervace byly vymaz√°ny.');
                loadReservations();
            } else {
                alert('Chyba p≈ôi resetu.');
            }
        }

        let dragPageIndex = null;

        function renderTeachers() {
            const list = document.getElementById('teachers-list');
            list.innerHTML = '';
            teachers.forEach((t, index) => {
                const row = document.createElement('div');
                row.className = 'teacher-item';
                row.draggable = true;
                row.dataset.index = index;
                
                row.innerHTML = `
                    <div class="drag-handle">‚ò∞</div>
                    <div style="display:flex; flex-direction:column; gap:2px; margin-right:5px;">
                        <button class="btn" style="padding:2px 5px; font-size:10px" onclick="moveTeacher(${index}, -1)" ${index === 0 ? 'disabled' : ''}>‚ñ≤</button>
                        <button class="btn" style="padding:2px 5px; font-size:10px" onclick="moveTeacher(${index}, 1)" ${index === teachers.length - 1 ? 'disabled' : ''}>‚ñº</button>
                    </div>
                    <input type="text" placeholder="Jm√©no" value="${t.name}" maxlength="50" style="flex:1" onchange="updateTeacher(${index}, 'name', this.value)">
                    <input type="number" placeholder="Minuty" value="${t.interval}" style="width: 70px" onchange="updateTeacher(${index}, 'interval', this.value)">
                    <button class="btn btn-red" onclick="removeTeacher(${index})">X</button>
                `;

                // Drag & Drop events
                row.addEventListener('dragstart', (e) => {
                    dragPageIndex = index;
                    row.classList.add('dragging');
                });

                row.addEventListener('dragend', () => {
                    row.classList.remove('dragging');
                });

                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    const draggingItem = document.querySelector('.dragging');
                    if (!draggingItem || draggingItem === row) return;
                    
                    const list = row.parentNode;
                    const items = [...list.querySelectorAll('.teacher-item')];
                    const nextItem = items.find(item => {
                        const box = item.getBoundingClientRect();
                        return e.clientY <= box.top + box.height / 2;
                    });
                    
                    if (nextItem) {
                        list.insertBefore(draggingItem, nextItem);
                    } else {
                        list.appendChild(draggingItem);
                    }
                });

                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const newItems = [...list.querySelectorAll('.teacher-item')];
                    const newOrder = newItems.map(item => teachers[parseInt(item.dataset.index)]);
                    teachers = newOrder;
                    renderTeachers();
                });

                list.appendChild(row);
            });
        }

        function moveTeacher(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= teachers.length) return;
            const temp = teachers[index];
            teachers[index] = teachers[newIndex];
            teachers[newIndex] = temp;
            renderTeachers();
        }

        function updateTeacher(index, field, value) {
            if (field === 'interval') value = parseInt(value);
            teachers[index][field] = value;
        }

        function addTeacher() {
            teachers.push({ id: 't' + Date.now(), name: 'Nov√Ω Uƒçitel', interval: 10 });
            renderTeachers();
        }

        function removeTeacher(index) {
            if (confirm('Opravdu smazat uƒçitele?')) {
                teachers.splice(index, 1);
                renderTeachers();
            }
        }

        async function saveSettings() {
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: sessionToken, teachers })
                });

                if (res.ok) {
                    alert('Nastaven√≠ ulo≈æeno');
                } else {
                    const data = await res.json();
                    alert('Chyba ukl√°d√°n√≠: ' + (data.error || 'Nezn√°m√° chyba'));
                }
            } catch (e) {
                alert('Chyba komunikace: ' + e.message);
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>

</html>
