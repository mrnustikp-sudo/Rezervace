<!DOCTYPE html>
<html lang="cs">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrace</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .admin-container {
            max-width: 800px;
            margin: 50px auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .teacher-item,
        .res-item {
            display: flex;
            align-items: center;
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            gap: 10px;
        }

        .res-item span {
            flex: 1;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-green {
            background-color: #4caf50;
        }

        .btn-red {
            background-color: #f44336;
        }

        .tabs {
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 16px;
        }

        .tab-btn.active {
            border-bottom: 3px solid #4caf50;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div id="login-screen" class="admin-container">
        <h2>Přihlášení</h2>
        <div class="form-group">
            <label>Heslo</label>
            <input type="password" id="admin-password">
        </div>
        <button class="btn" onclick="login()">Přihlásit</button>
    </div>

    <div id="dashboard-screen" class="admin-container" style="display:none;">
        <div
            style="background:#f0f0f0; padding:10px; margin-bottom:15px; border-radius:4px; font-size:12px; color:#555;">
            Stav úložiště: <strong id="storage-status">Loading...</strong>
        </div>
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('teachers')">Učitelé</button>
            <button class="tab-btn" onclick="showTab('reservations')">Rezervace</button>
        </div>

        <!-- TEACHERS TAB -->
        <div id="tab-teachers">
            <h2>Správa učitelů</h2>
            <div id="teachers-list"></div>
            <button class="btn btn-green" onclick="addTeacher()" style="margin-top: 15px;">+ Přidat učitele</button>
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <button class="btn" onclick="saveSettings()">Uložit nastavení</button>
            </div>
        </div>

        <!-- RESERVATIONS TAB -->
        <div id="tab-reservations" style="display:none;">
            <h2>Správa rezervací</h2>
            <button class="btn" onclick="loadReservations()" style="margin-bottom: 10px;">Obnovit data</button>
            <div id="reservations-list"></div>
        </div>

        <button class="btn btn-red" onclick="logout()" style="margin-top: 30px;">Odhlásit</button>
    </div>

    <script>
        let sessionToken = null;
        let teachers = [];

        async function login() {
            const password = document.getElementById('admin-password').value;
            try {
                const res = await fetch('/api/admin/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                // Handle non-JSON response (e.g. 500 HTML)
                const contentType = res.headers.get("content-type");
                let data;
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    data = await res.json();
                } else {
                    throw new Error('Server returned non-JSON error (Check logs)');
                }

                if (data.success) {
                    sessionToken = data.token;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('dashboard-screen').style.display = 'block';
                    loadConfig();
                    loadReservations();
                } else {
                    alert('Chyba: ' + (data.error || 'Špatné heslo'));
                }
            } catch (e) {
                alert('Chyba komunikace se serverem. Zkontrolujte logy na Renderu. ' + e.message);
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`button[onclick="showTab('${tab}')"]`).classList.add('active');

            document.getElementById('tab-teachers').style.display = tab === 'teachers' ? 'block' : 'none';
            document.getElementById('tab-reservations').style.display = tab === 'reservations' ? 'block' : 'none';
        }

        async function loadConfig() {
            const res = await fetch('/api/config');
            const data = await res.json();
            teachers = data.teachers;
            if (data.storageMode) {
                document.getElementById('storage-status').textContent = data.storageMode;
                if (data.storageMode.includes('Google')) {
                    document.getElementById('storage-status').style.color = 'green';
                }
            }
            renderTeachers();
        }

        async function loadReservations() {
            const res = await fetch('/api/reservations');
            const data = await res.json(); // { Teacher: { Time: {name, id} } }

            const list = document.getElementById('reservations-list');
            list.innerHTML = '';

            Object.keys(data).forEach(teacher => {
                Object.keys(data[teacher]).forEach(time => {
                    const r = data[teacher][time];
                    if (r) {
                        const row = document.createElement('div');
                        row.className = 'res-item';
                        row.innerHTML = `
                            <span style="font-weight:bold; width: 100px;">${teacher}</span>
                            <span style="width: 60px;">${time}</span>
                            <span>${r.name}</span>
                            <button class="btn btn-red" onclick="deleteReservation('${teacher}', '${time}')">Smazat</button>
                        `;
                        list.appendChild(row);
                    }
                });
            });

            if (list.children.length === 0) list.innerHTML = '<p>Žádné aktivní rezervace.</p>';
        }

        async function deleteReservation(teacher, time) {
            if (!confirm(`Opravdu smazat rezervaci ${teacher} v ${time}?`)) return;

            const res = await fetch('/api/admin/delete-reservation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token: sessionToken, teacher, time })
            });

            if (res.ok) {
                loadReservations();
            } else {
                const err = await res.json();
                alert('Chyba při mazání: ' + (err.error || 'Neznámá chyba'));
            }
        }

        function renderTeachers() {
            const list = document.getElementById('teachers-list');
            list.innerHTML = '';
            teachers.forEach((t, index) => {
                const row = document.createElement('div');
                row.className = 'teacher-item';
                row.innerHTML = `
                    <input type="text" placeholder="Jméno" value="${t.name}" onchange="updateTeacher(${index}, 'name', this.value)">
                    <input type="number" placeholder="Minuty" value="${t.interval}" style="width: 70px" onchange="updateTeacher(${index}, 'interval', this.value)">
                    <button class="btn btn-red" onclick="removeTeacher(${index})">X</button>
                `;
                list.appendChild(row);
            });
        }

        function updateTeacher(index, field, value) {
            if (field === 'interval') value = parseInt(value);
            teachers[index][field] = value;
        }

        function addTeacher() {
            teachers.push({ id: 't' + Date.now(), name: 'Nový Učitel', interval: 10 });
            renderTeachers();
        }

        function removeTeacher(index) {
            if (confirm('Opravdu smazat?')) {
                teachers.splice(index, 1);
                renderTeachers();
            }
        }

        async function saveSettings() {
            try {
                const res = await fetch('/api/admin/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token: sessionToken, teachers })
                });

                if (res.ok) {
                    alert('Nastavení uloženo');
                } else {
                    const data = await res.json();
                    alert('Chyba ukládání: ' + (data.error || 'Neznámá chyba'));
                }
            } catch (e) {
                alert('Chyba komunikace: ' + e.message);
            }
        }

        function logout() {
            location.reload();
        }
    </script>
</body>

</html>